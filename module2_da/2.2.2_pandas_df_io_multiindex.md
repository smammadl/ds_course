# 2.2. Data Manipulation with Pandas

## Pandas Data Structures: DataFrame

A **DataFrame** is a two-dimensional labeled data structure with columns of potentially different types. It is similar to a spreadsheet, a SQL table, or a dictionary of Series objects. It is the most commonly used pandas object.

## Creating a DataFrame

You can create a DataFrame from a dictionary of lists, where each list represents a column.

```python
import pandas as pd

# Creating a DataFrame from a dictionary
data = {
    'Name': ['Alice', 'Bob', 'Charlie', 'David'],
    'Age': [25, 30, 35, 40],
    'City': ['New York', 'Los Angeles', 'Chicago', 'Houston']
}
df = pd.DataFrame(data)
print(df)
```

**Output:**

```
      Name  Age         City
0    Alice   25     New York
1      Bob   30  Los Angeles
2  Charlie   35      Chicago
3    David   40      Houston
```

You can also create a DataFrame from a dictionary of `Series` objects:

```python
weight_series = pd.Series([68, 83, 112], index=["alice", "bob", "charles"])
birthyear_series = pd.Series([1984, 1985, 1992], index=["bob", "alice", "charles"], name="year")
children_series = pd.Series([0, 3], index=["charles", "bob"])
hobby_series = pd.Series(["Biking", "Dancing"], index=["alice", "bob"])

people_dict = {
    "weight": weight_series,
    "birthyear": birthyear_series,
    "children": children_series,
    "hobby": hobby_series,
}
people = pd.DataFrame(people_dict)
people
```

**Output:**

```
         weight  birthyear  children    hobby
alice        68       1985       NaN   Biking
bob          83       1984       3.0  Dancing
charles     112       1992       0.0      NaN
```

> **Note:** The `Series` were automatically aligned based on the indices and the missing values are represented as `NaN`. Also note that the name `year` was dropped from the `birthyear` `Series`.

> **Note:** The index of the `DataFrame` can be accessed using the `index` attribute.
> ```python
> people.index
> ```
> **Output:**
> ```
> Index(['alice', 'bob', 'charles'], dtype='object')
> ```
> ```python
> people.columns
> ```
> **Output:**
> ```
> Index(['weight', 'birthyear', 'children', 'hobby'], dtype='object')
> ```

You can access columns using the `[]` operator. They are returned as `Series` objects:

```python
people["birthyear"]
```

**Output:**

```
alice      1985
bob        1984
charles    1992
Name: birthyear, dtype: int64
```

You can also get multiple columns at once:
```python
people[["birthyear", "hobby"]]
```

**Output:**

```
         birthyear    hobby
alice       1985   Biking
bob         1984  Dancing
charles     1992      NaN
dtype: object
```

If you pass a list of columns and/or index row labels to the `DataFrame` constructor.

```python
d2 = pd.DataFrame(
        people_dict,
        columns=["birthyear", "weight", "height"], # reorder the columns
        index=["bob", "alice", "eugene"] # reorder the index
     )
d2
```
**Output:**

```
        birthyear  weight height
bob        1984.0    83.0    NaN
alice      1985.0    68.0    NaN
eugene        NaN     NaN    NaN
```

### Alternative Constructors

Another convenient way to create a `DataFrame` is to pass all the values to the constructor as an `ndarray`, or a list of lists, and specify the column names and row index labels separately:

```python
values = [
            [1985, np.nan, "Biking",   68],
            [1984, 3,      "Dancing",  83],
            [1992, 0,      np.nan,    112]
         ]
d3 = pd.DataFrame(
        values,
        columns=["birthyear", "children", "hobby", "weight"],
        index=["alice", "bob", "charles"]
     )
d3
```

**Output:**

```
         birthyear  children    hobby  weight
alice         1985       NaN   Biking      68
bob           1984       3.0  Dancing      83
charles       1992       0.0      NaN     112
```

It is also possible to create a `DataFrame` with a dictionary (or list) of dictionaries (or lists):

```python
people = pd.DataFrame({
    "birthyear": {"alice": 1985, "bob": 1984, "charles": 1992},
    "hobby": {"alice": "Biking", "bob": "Dancing"},
    "weight": {"alice": 68, "bob": 83, "charles": 112},
    "children": {"bob": 3, "charles": 0}
})
people
```

**Output:**

```
         birthyear    hobby  weight  children
alice         1985   Biking      68       NaN
bob           1984  Dancing      83       3.0
charles       1992      NaN     112       0.0
```

## Reading and Writing Data

Pandas provides a rich set of functions for reading data from various file formats and writing data back to them. The most common formats include CSV, Excel, JSON, and SQL databases.

**Example: Reading a CSV file**

Let's assume you have a CSV file named `data.csv` with the following content:

```csv
Name,Age,City
Alice,25,New York
Bob,30,Los Angeles
Charlie,35,Chicago
David,40,Houston
```

You can read this file into a DataFrame using `pd.read_csv()`:

```python
import pandas as pd

df = pd.read_csv('data.csv')
print(df)
```

**Example: Writing to a CSV file**

You can write a DataFrame to a CSV file using the `to_csv()` method.

```python
df.to_csv('output.csv', index=False)
```

The `index=False` argument prevents pandas from writing the DataFrame index as a column in the CSV file.

**Example: Reading and Writing Excel Files**

Pandas can also seamlessly work with Excel files, but it requires an additional library to handle the file format. The most common one is `openpyxl`. You can install it using pip:
```
pip install openpyxl xlsxwriter
```

**Example: Writing to an Excel file**

You can write a DataFrame to an Excel file using the `to_excel()` method.

```python
# The DataFrame 'df' from the previous example is used here
df.to_excel('output.xlsx', sheet_name='People', index=False)
```
This will create an Excel file named `output.xlsx` with a sheet named `People`, containing the data from your DataFrame.

**Example: Reading from an Excel file**

You can read data from an Excel file using `pd.read_excel()`.

```python
df_from_excel = pd.read_excel('output.xlsx', sheet_name='People')
print(df_from_excel)
```

## Multi-Index DataFrame
```python
d5 = pd.DataFrame(
    {
        ("public", "birthyear"):{
            ("Paris","alice"): 1985, 
            ("Paris","bob"): 1984, 
            ("London","charles"): 1992
        },
        ("public", "hobby"):{
            ("Paris","alice"): "Biking", 
            ("Paris","bob"): "Dancing"
        },
        ("private", "weight"):{
            ("Paris","alice"): 68, 
            ("Paris","bob"): 83, 
            ("London","charles"): 112
        },
        ("private", "children"):{
            ("Paris", "alice"): np.nan, 
            ("Paris","bob"): 3, 
            ("London","charles"): 0
        }
    }
)
d5
```

**Output:**

```
                public              private         
                birthyear    hobby  weight children
Paris  alice        1985   Biking      68      NaN
       bob          1984  Dancing      83      3.0
London charles      1992      NaN     112      0.0
```

You can now get a `DataFrame` containing all the `"public"` columns very simply:
```python
d5["public"]
```

**Output:**

```
                birthyear    hobby
Paris  alice         1985   Biking
       bob           1984  Dancing
London charles       1992      NaN
```

```python
d5["public", "hobby"]  # Same result as d5["public"]["hobby"]
```

**Output:**

```
Paris   alice       Biking
        bob        Dancing
London  charles        NaN
Name: (public, hobby), dtype: object
```

> **Note:** Multi-Index DataFrame can also be created using the `MultiIndex` class.
> ```python
> columns = pd.MultiIndex.from_tuples([
>     ('public', 'birthyear'), 
>     ('public', 'hobby'), 
>     ('private', 'weight'), 
>     ('private', 'children')
> ])
> index = pd.MultiIndex.from_tuples([
>     ('Paris', 'alice'), 
>     ('Paris', 'bob'), 
>     ('London', 'charles')
> ])
> data = [
>     [1985, 'Biking', 68, 'NaN'],
>     [1984, 'Dancing', 83, 3.0],
>     [1992, 'NaN', 112, 0.0]
>     ]
> d5 = pd.DataFrame(data, index=index, columns=columns)
> d5
> ```
> **Output:**
> ```
>                   public              private         
>                   birthyear    hobby  weight children
> Paris  alice        1985   Biking      68      NaN
>        bob          1984  Dancing      83      3.0
> London charles      1992      NaN     112      0.0
> ```
> Or even simpler:
> ```python
> d5 = pd.DataFrame(
>     data, 
>     index=[['Paris', 'Paris', 'London'], ['alice', 'bob', 'charles']], 
>     columns=[['public', 'public', 'private', 'private'], ['birthyear','hobby', 'weight', 'children']]
> )
> d5
> ```
> **Output:**
> ```
>                   public              private         
>                   birthyear    hobby  weight children
> Paris  alice        1985   Biking      68      NaN
>        bob          1984  Dancing      83      3.0
> London charles      1992      NaN     112      0.0
> ```

There are two levels of columns, and two levels of indices. We can drop a column level by calling `droplevel()` (the same goes for indices):

```python
d5.columns = d5.columns.droplevel(level = 0)
d5
```

**Output:**

```
                birthyear    hobby  weight  children
Paris  alice         1985   Biking      68       NaN
       bob           1984  Dancing      83       3.0
London charles       1992      NaN     112       0.0
```

```python
d6 = d5.T
d6
```

**Output:**

```
            Paris           London
            alice      bob charles
birthyear    1985     1984    1992
hobby      Biking  Dancing     NaN
weight         68       83     112
children      NaN      3.0     0.0
```

### Stacking and Unstacking

Calling the `stack()` method will push the lowest column level after the lowest index:

```python
d7 = d6.stack()
d7
```

**Output:**

```python
                     Paris London
birthyear alice       1985    NaN
          bob         1984    NaN
          charles      NaN   1992
hobby     alice     Biking    NaN
          bob      Dancing    NaN
weight    alice         68    NaN
          bob           83    NaN
          charles      NaN    112
children  bob          3.0    NaN
          charles      NaN    0.0
```

Calling `unstack()` will do the reverse, once again creating many `NaN` values.

> **Note:** Many `NaN` values appeared. This is because many new combinations did not exist before.

```python
d8 = d7.unstack()
d8
```

**Output:**
```
            Paris                  London             
            alice      bob charles  alice  bob charles
birthyear    1985     1984     NaN    NaN  NaN    1992
children      NaN      3.0     NaN    NaN  NaN     0.0
hobby      Biking  Dancing     NaN    NaN  NaN     NaN
weight         68       83     NaN    NaN  NaN     112
```

If we call `unstack` again, we end up with a `Series` object:
```python
d9 = d8.unstack()
d9
```

**Output:**
```
Paris   alice    birthyear       1985
                 children         NaN
                 hobby         Biking
                 weight            68
        bob      birthyear       1984
                 children         3.0
                 hobby        Dancing
                 weight            83
        charles  birthyear        NaN
                 children         NaN
                 hobby            NaN
                 weight           NaN
London  alice    birthyear        NaN
                 children         NaN
                 hobby            NaN
                 weight           NaN
        bob      birthyear        NaN
                 children         NaN
                 hobby            NaN
                 weight           NaN
        charles  birthyear       1992
                 children         0.0
                 hobby            NaN
                 weight           112
dtype: object
```

## Operations on Indexes and Columns
```python
df
```
**Output:**
```
        CCA3        Continent   Country             Capital
0       AFG         Asia        Afghanistan         Kabul
1       ALB         Europe      Albania             Tirana
2       DZA         Africa      Algeria             Algiers
3       ASM         Oceania     American Samoa      Pago Pago
4       AND         Europe      Andorra             Andorra la Vella
...     ...         ...     ...     ...
229     WLF         Oceania     Wallis and Futuna   Mata-Utu
230     ESH         Africa      Western Sahara      El Aaiún
231     YEM         Asia        Yemen               Sanaa
232     ZMB         Africa      Zambia              Lusaka
233     ZWE         Africa      Zimbabwe            Harare
234 rows × 4 columns
```

To rename the columns, we can use the `rename()` method.
```python
df = df.rename(columns={'CCA3': 'Country Code'})
df.head()
```
**Output:**
```
  Country Code Continent         Country           Capital
0          AFG      Asia     Afghanistan             Kabul
1          ALB    Europe         Albania            Tirana
2          DZA    Africa         Algeria           Algiers
3          ASM   Oceania  American Samoa         Pago Pago
4          AND    Europe         Andorra  Andorra la Vella

You can use `set_index()` to set the 'Country Code' column as the index.
```python
df.set_index('Country Code').head()
```
**Output:**
```
             Continent         Country           Capital
Country Code                                            
AFG               Asia     Afghanistan             Kabul
ALB             Europe         Albania            Tirana
DZA             Africa         Algeria           Algiers
ASM            Oceania  American Samoa         Pago Pago
AND             Europe         Andorra  Andorra la Vella
```
You can also pass the list to create multi-index.
```python
df.set_index(['Continent', 'Country Code']).head()
```
**Output:**
```
                               Country           Capital
Continent Country Code                                  
Asia      AFG              Afghanistan             Kabul
Europe    ALB                  Albania            Tirana
Africa    DZA                  Algeria           Algiers
Oceania   ASM           American Samoa         Pago Pago
Europe    AND                  Andorra  Andorra la Vella
```
Adding `sort_index()` will sort the index.
```python
df = df.set_index(['Continent', 'Country Code']).sort_index()
df.head()
```
**Output:**
```
                             Country      Capital
Continent Country Code                           
Africa    AGO                 Angola       Luanda
          BDI                Burundi    Bujumbura
          BEN                  Benin   Porto-Novo
          BFA           Burkina Faso  Ouagadougou
          BWA               Botswana     Gaborone
```
You can use `reset_index()` to reset the index to the default index (0, 1, 2, ...).
```python
df.reset_index().head()
```
**Output:**
```
  Continent Country Code       Country      Capital
0    Africa          AGO        Angola       Luanda
1    Africa          BDI       Burundi    Bujumbura
2    Africa          BEN         Benin   Porto-Novo
3    Africa          BFA  Burkina Faso  Ouagadougou
4    Africa          BWA      Botswana     Gaborone
```